<!DOCTYPE html>
<html>
<head>
    <title>Debug Dashboard</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #00ff00; margin-top: 0; }
        h2 { color: #00ccff; border-bottom: 2px solid #00ccff; padding-bottom: 10px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section {
            background: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #00ccff;
        }
        .log {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 13px;
            background: #1e1e1e;
            padding: 15px;
            border-radius: 3px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #444;
        }
        .log-line { margin: 2px 0; }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; font-weight: bold; }
        .log-info { color: #9cdcfe; }
        .log-warning { color: #ff8844; }
        .status-bar {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        .status-box {
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .status-ok { background: #2a5a2a; color: #4ec9b0; }
        .status-error { background: #5a2a2a; color: #f48771; }
        .status-pending { background: #5a4a2a; color: #ff8844; }
        button {
            background: #00ccff;
            color: #1e1e1e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
            margin: 5px;
        }
        button:hover { background: #00ffff; }
        button:active { opacity: 0.8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Dashboard Debug Console</h1>
        <p>This page helps diagnose why data isn't showing on the dashboard.</p>

        <div class="status-bar">
            <div class="status-box status-pending" id="status-loading">‚è≥ Checking Systems...</div>
            <div class="status-box status-pending" id="status-scripts">‚è≥ Scripts...</div>
            <div class="status-box status-pending" id="status-apis">‚è≥ APIs...</div>
        </div>

        <div style="margin: 20px 0;">
            <button onclick="location.reload()">üîÑ Refresh Page</button>
            <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            <button onclick="testAPIsManually()">üß™ Test APIs</button>
        </div>

        <div class="section">
            <h2>üìã Script Loading</h2>
            <div id="script-log" class="log"></div>
        </div>

        <div class="grid">
            <div class="section">
                <h2>üåê API Tests</h2>
                <div id="api-log" class="log"></div>
            </div>

            <div class="section">
                <h2>üìä Data Received</h2>
                <div id="data-log" class="log"></div>
            </div>
        </div>

        <div class="section">
            <h2>‚úÖ Diagnostic Summary</h2>
            <div id="summary-log" class="log"></div>
        </div>
    </div>

    <script>
        const logs = {
            script: [],
            api: [],
            data: [],
            summary: []
        };

        const results = {
            chartsLoaded: false,
            commonLoaded: false,
            dashboardLoaded: false,
            apisWorking: 0,
            totalApis: 5,
            errors: []
        };

        function formatLogLine(type, message) {
            let className = 'log-info';
            if (message.includes('[ERROR]')) className = 'log-error';
            else if (message.includes('[LOAD]')) className = 'log-success';
            else if (message.includes('[START]') || message.includes('[END]')) className = 'log-info';
            return `<div class="log-line ${className}">${message}</div>`;
        }

        function addLog(type, message) {
            logs[type].push(message);
            const logElement = document.getElementById(`${type}-log`);
            if (logElement) {
                logElement.innerHTML += formatLogLine(type, message);
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        function addSummary(message) {
            logs.summary.push(message);
            const el = document.getElementById('summary-log');
            if (el) {
                el.innerHTML += formatLogLine('summary', message);
            }
        }

        function clearLogs() {
            logs.script = [];
            logs.api = [];
            logs.data = [];
            logs.summary = [];
            document.getElementById('script-log').innerHTML = '';
            document.getElementById('api-log').innerHTML = '';
            document.getElementById('data-log').innerHTML = '';
            document.getElementById('summary-log').innerHTML = '';
        }

        // Intercept console
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog(...args);
            const msg = args.join(' ');
            if (msg.includes('[Common]') || msg.includes('[Dashboard]')) {
                addLog('script', msg);
            }
        };

        const originalError = console.error;
        console.error = function(...args) {
            originalError(...args);
            const msg = args.join(' ');
            addLog('script', `[ERROR] ${msg}`);
            results.errors.push(msg);
        };

        addLog('script', '[INIT] Debug page loaded');
    </script>

    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        results.chartsLoaded = typeof Chart !== 'undefined';
        addLog('script', `[LOAD] Chart.js ${results.chartsLoaded ? '‚úì' : '‚úó'} ${typeof Chart}`);
        if (results.chartsLoaded) {
            document.getElementById('status-scripts').className = 'status-box status-ok';
            document.getElementById('status-scripts').innerHTML = '‚úì Chart.js Loaded';
        }
    </script>

    <!-- Load common.js -->
    <script src="/static/js/common.js"></script>
    <script>
        results.commonLoaded = typeof window.dashboardUtils !== 'undefined';
        addLog('script', '[LOAD] common.js ‚úì');
        addLog('script', `  window.dashboardUtils = ${typeof window.dashboardUtils}`);
        if (window.dashboardUtils) {
            const funcs = Object.keys(window.dashboardUtils).slice(0, 5).join(', ') + '...';
            addLog('script', `  Functions: ${funcs}`);
        } else {
            results.errors.push('window.dashboardUtils not found');
        }
    </script>

    <!-- Load dashboard.js -->
    <script>
        addLog('script', '[LOAD] About to load dashboard.js');
    </script>
    <script src="/static/js/dashboard.js"></script>
    <script>
        results.dashboardLoaded = true;
        addLog('script', '[LOAD] dashboard.js loaded successfully ‚úì');

        // Update status
        if (results.chartsLoaded && results.commonLoaded && results.dashboardLoaded) {
            document.getElementById('status-loading').className = 'status-box status-ok';
            document.getElementById('status-loading').innerHTML = '‚úì All Scripts OK';
        }
    </script>

    <!-- Test API calls -->
    <script>
        async function testAPIsManually() {
            addLog('api', '[START] Manually testing API endpoints...');
            await testAPIs();
            await generateSummary();
        }

        async function testAPIs() {
            addLog('api', '[START] Testing API endpoints...');

            const endpoints = [
                { url: '/api/health', name: 'Health' },
                { url: '/api/dashboard/stats', name: 'Dashboard Stats' },
                { url: '/api/sentiment/summary', name: 'Sentiment' },
                { url: '/api/stocks/top?limit=3', name: 'Top Stocks' },
                { url: '/api/llm/recent?limit=5', name: 'LLM Recent' }
            ];

            results.apisWorking = 0;
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url);
                    const data = await response.json();

                    if (response.status === 200) {
                        results.apisWorking++;
                        addLog('api', `‚úì [200] ${endpoint.name}`);

                        const preview = JSON.stringify(data).substring(0, 100);
                        addLog('data', `${endpoint.name}: ${preview}...`);
                    } else {
                        addLog('api', `‚úó [${response.status}] ${endpoint.name}`);
                    }
                } catch (error) {
                    addLog('api', `‚úó [ERROR] ${endpoint.name}: ${error.message}`);
                }
            }

            addLog('api', `[END] ${results.apisWorking}/${results.totalApis} APIs working`);
            updateStatusBars();
        }

        function updateStatusBars() {
            const loadingOk = results.chartsLoaded && results.commonLoaded && results.dashboardLoaded;
            const apisOk = results.apisWorking === results.totalApis;

            if (loadingOk) {
                document.getElementById('status-loading').className = 'status-box status-ok';
                document.getElementById('status-loading').innerHTML = '‚úì Scripts OK';
            }

            if (apisOk) {
                document.getElementById('status-apis').className = 'status-box status-ok';
                document.getElementById('status-apis').innerHTML = `‚úì APIs (${results.apisWorking}/${results.totalApis})`;
            } else if (results.apisWorking > 0) {
                document.getElementById('status-apis').className = 'status-box status-warning';
                document.getElementById('status-apis').innerHTML = `‚ö† APIs (${results.apisWorking}/${results.totalApis})`;
            } else {
                document.getElementById('status-apis').className = 'status-box status-error';
                document.getElementById('status-apis').innerHTML = `‚úó APIs Failed`;
            }
        }

        async function generateSummary() {
            addSummary('[SUMMARY] Diagnostic Results:');
            addSummary(`  Chart.js loaded: ${results.chartsLoaded ? '‚úì' : '‚úó'}`);
            addSummary(`  common.js loaded: ${results.commonLoaded ? '‚úì' : '‚úó'}`);
            addSummary(`  dashboard.js loaded: ${results.dashboardLoaded ? '‚úì' : '‚úó'}`);
            addSummary(`  APIs working: ${results.apisWorking}/${results.totalApis}`);

            if (results.errors.length > 0) {
                addSummary(`  Errors found: ${results.errors.length}`);
                results.errors.forEach(err => {
                    addSummary(`    - ${err}`);
                });
            }

            if (results.chartsLoaded && results.commonLoaded && results.dashboardLoaded && results.apisWorking === results.totalApis) {
                addSummary('[CONCLUSION] ‚úì Everything looks good!');
                addSummary('[NEXT] Try the main dashboard at http://localhost:5000');
            } else {
                addSummary('[CONCLUSION] ‚úó Issues found - see above');
            }
        }

        // Wait for DOM ready
        document.addEventListener('DOMContentLoaded', async function() {
            addLog('script', '[DOM] DOMContentLoaded fired');
            await testAPIs();
            await generateSummary();
        });
    </script>

    <script>
        addLog('script', '[READY] Debug page fully loaded');
    </script>
</body>
</html>
